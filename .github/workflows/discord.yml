# ê°œë°œ í›„, í…ŒìŠ¤íŠ¸ ë§í¬ ì „ë‹¬
# í˜„ìž¬ ë¸Œëžœì¹˜ì˜ develop, production.zipì„ ì „ë‹¬
name: Discord Notification

on:
    pull_request:
        types: [opened, synchronize]
        branches: [main]
    workflow_dispatch:

jobs:
    notify-discord:
        runs-on: ubuntu-latest
        steps:
            # 1. ì €ìž¥ì†Œ í´ë¡ 
            - name: Checkout code
              uses: actions/checkout@v3

            # 2. Node.js ì„¤ì¹˜
            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: "20"

            # 3. manifest.jsonì—ì„œ version ì½ê¸°
            - name: Extract version from manifest.json
              id: get_version
              run: |
                  VERSION=$(node -p "require('./public/manifest.json').version")
                  echo "Version: $VERSION"
                  echo "VERSION=$VERSION" >> $GITHUB_ENV

            # 4. ë§í¬ ìƒì„±
            - name: Create zip file link
              id: create_link
              run: |
                  ZIP_LINK="https://github.com/${{ github.repository }}/blob/${{ github.head_ref }}/build/production/build-${VERSION}.zip"
                  echo "Zip link: $ZIP_LINK"
                  echo "ZIP_LINK=$ZIP_LINK" >> $GITHUB_ENV

            # 5. Discord ì•Œë¦¼ ì „ì†¡ (open ì‹œ)
            - name: Send Discord notification for PR opened
              if: github.event.action == 'opened'
              run: |
                  PR_TITLE="${{ github.event.pull_request.title }}"
                  PR_LINK="${{ github.event.pull_request.html_url }}"
                  curl -X POST -H 'Content-type:application/json' \
                  -d "{
                      \"content\": \"**[Pocket Prompt Extension]** - ${PR_TITLE} \n- PR Link : ${PR_LINK}\n- Zip file : ${ZIP_LINK}\"
                  }" \
                  ${{ secrets.DISCORD_WEBHOOK_URL }}

            # 6. Discord ì•Œë¦¼ ì „ì†¡ (synchronized ì‹œ)
            - name: Send Discord notification for PR synchronized
              if: github.event.action == 'synchronize'
              run: |
                  PR_TITLE="${{ github.event.pull_request.title }}"
                  curl -X POST -H 'Content-type:application/json' \
                  -d "{
                      \"content\": \"**[Pocket Prompt Extension]** - ${PR_TITLE} ðŸ”„ \n- Zip file : ${ZIP_LINK}\"
                  }" \
                  ${{ secrets.DISCORD_WEBHOOK_URL }}
