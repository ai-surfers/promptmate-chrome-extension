# Í∞úÎ∞ú ÌõÑ, ÌÖåÏä§Ìä∏ ÎßÅÌÅ¨ Ï†ÑÎã¨
# ÌòÑÏû¨ Î∏åÎûúÏπòÏùò develop, production.zipÏùÑ Ï†ÑÎã¨
name: Discord Notification

on:
    pull_request:
        types: [opened]
        branches: [main]
    workflow_dispatch:

jobs:
    notify-discord:
        runs-on: ubuntu-latest
        steps:
            # 1. Ï†ÄÏû•ÏÜå ÌÅ¥Î°†
            - name: Checkout code
              uses: actions/checkout@v3

            # 2. Node.js ÏÑ§Ïπò
            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: "20"

            # 3. manifest.jsonÏóêÏÑú version ÏùΩÍ∏∞
            - name: Extract version from manifest.json
              id: get_version
              run: |
                  VERSION=$(node -p "require('./public/manifest.json').version")
                  echo "Version: $VERSION"
                  echo "VERSION=$VERSION" >> $GITHUB_ENV

            # 4. ÎßÅÌÅ¨ ÏÉùÏÑ±
            - name: Create zip file link
              id: create_link
              run: |
                  ZIP_LINK="https://github.com/${{ github.repository }}/blob/${{ github.ref }}/build/production/build-${VERSION}.zip"
                  echo "Zip link: $ZIP_LINK"
                  echo "ZIP_LINK=$ZIP_LINK" >> $GITHUB_ENV

            # 5. Discord ÏïåÎ¶º Ï†ÑÏÜ° (open Ïãú)
            - name: Send Discord notification for PR opened
              if: github.event.action == 'opened'
              run: |
                  PR_TITLE="${{ github.event.pull_request.title }}"
                  PR_LINK="${{ github.event.pull_request.html_url }}"
                  curl -X POST -H 'Content-type:application/json' \
                  -d "{
                      \"content\": \"**[Pocket Prompt Extension]** - ${PR_TITLE} \n- PR Link : ${PR_LINK}\n- Zip file : ${ZIP_LINK}\"
                  }" \
                  ${{ secrets.DISCORD_WEBHOOK_URL }}

            # 6. Discord ÏïåÎ¶º Ï†ÑÏÜ° (ÏßÅÏ†ë Ïã§Ìñâ Ïãú)
            - name: Send Discord notification for workflow_dispatch
              if: github.event_name == 'workflow_dispatch'
              run: |
                  PR_TITLE="${{ github.event.pull_request.title }}"
                  curl -X POST -H 'Content-type:application/json' \
                  -d "{
                      \"content\": \"**[Pocket Prompt Extension]** - ${PR_TITLE} üîÑ \n- Zip file : ${ZIP_LINK}\"
                  }" \
                  ${{ secrets.DISCORD_WEBHOOK_URL }}
